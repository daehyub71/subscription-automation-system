#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ë©”ì¸ GUI ì°½ ëª¨ë“ˆ (ì™„ì „í•œ ì˜¤ë¥˜ ìˆ˜ì • ë²„ì „)
íŒŒì¼ëª…: gui/main_window.py
ì‘ì„±ì: ì²­ì•½ ìë™í™” ì‹œìŠ¤í…œ
ì„¤ëª…: tkinterë¥¼ ì‚¬ìš©í•œ ë©”ì¸ ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤
"""

import tkinter as tk
from tkinter import ttk, messagebox, filedialog, scrolledtext
import threading
import logging
import os
import sys
import urllib.parse
import json
from datetime import datetime
from typing import Dict, List, Optional

# ìƒìœ„ ë””ë ‰í† ë¦¬ì˜ ëª¨ë“ˆ importë¥¼ ìœ„í•œ ê²½ë¡œ ì¶”ê°€
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# ì•ˆì „í•œ importë¥¼ ìœ„í•œ try-except
try:
    from utils.config_manager import ConfigManager
except ImportError:
    # ConfigManagerê°€ ì—†ìœ¼ë©´ ì„ì‹œ í´ë˜ìŠ¤ ìƒì„±
    class ConfigManager:
        def __init__(self):
            self.config_path = "config/settings.json"
        
        def load_config(self):
            return self._safe_load_config()
        
        def _safe_load_config(self):
            try:
                if os.path.exists(self.config_path):
                    with open(self.config_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                        # URL ì¸ì½”ë”©ëœ ë¶€ë¶„ ì²˜ë¦¬
                        config = json.loads(content)
                        return self._process_config(config)
                else:
                    return self._create_default_config()
            except Exception as e:
                print(f"ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: {e}")
                return self._create_default_config()
        
        def _process_config(self, config):
            # ì„œë¹„ìŠ¤í‚¤ URL ë””ì½”ë”© ì²˜ë¦¬
            if 'api' in config and 'service_key' in config['api']:
                service_key = config['api']['service_key']
                if isinstance(service_key, str) and '%' in service_key:
                    try:
                        decoded_key = urllib.parse.unquote(service_key)
                        config['api']['service_key'] = decoded_key
                        print("ì„œë¹„ìŠ¤í‚¤ URL ë””ì½”ë”© ì™„ë£Œ")
                    except:
                        pass
            return config
        
        def _create_default_config(self):
            return {
                'api': {'service_key': '', 'max_rows': 50},
                'naver_api': {'enabled': False, 'client_id': '', 'client_secret': ''},
                'email': {'sender_email': '', 'app_password': '', 'recipients': []},
                'kakao': {'enabled': False, 'api_key': ''},
                'schedule': {'enabled': False, 'time': '09:00'}
            }
        
        def save_config(self, config_data):
            try:
                os.makedirs(os.path.dirname(self.config_path), exist_ok=True)
                with open(self.config_path, 'w', encoding='utf-8') as f:
                    json.dump(config_data, f, ensure_ascii=False, indent=2)
                return True
            except Exception as e:
                print(f"ì„¤ì • ì €ì¥ ì˜¤ë¥˜: {e}")
                return False
        
        def validate_config(self, config_data):
            errors = []
            if not config_data['api']['service_key']:
                errors.append("API ì„œë¹„ìŠ¤í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤")
            return len(errors) == 0, errors
        
        def fix_url_encoding_issues(self):
            return True

try:
    from api.public_data import PublicDataAPI
except ImportError:
    class PublicDataAPI:
        def __init__(self, service_key):
            self.service_key = service_key
        def test_connection(self):
            return True, "API ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        def get_comprehensive_data(self, max_rows=50):
            return {'apt': [], 'officetel': [], 'remndr': [], 'public_rent': [], 'opt': []}

try:
    from utils.excel_handler import ExcelHandler
except ImportError:
    class ExcelHandler:
        def create_test_excel(self):
            return "test_file.xlsx"
        def create_excel_file(self, data):
            return "output.xlsx"

try:
    from utils.email_sender import EmailSender
except ImportError:
    class EmailSender:
        def test_connection(self, sender, password):
            return True, "ì´ë©”ì¼ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        def send_test_email(self, sender, password, recipient):
            return True, "í…ŒìŠ¤íŠ¸ ì„±ê³µ"
        def send_subscription_email(self, sender, password, recipients, file, data):
            return True, "ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ"

try:
    from api.kakao_api import create_kakao_api
except ImportError:
    def create_kakao_api(api_key, enabled):
        class MockKakaoAPI:
            def send_subscription_notification(self, data):
                return True, "ì¹´ì¹´ì˜¤í†¡ ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        return MockKakaoAPI()

class SubscriptionGUI:
    """ì²­ì•½ ë¶„ì–‘ì •ë³´ ìë™í™” ì‹œìŠ¤í…œ GUI í´ë˜ìŠ¤"""
    
    def __init__(self):
        """GUI ì´ˆê¸°í™”"""
        self.root = tk.Tk()
        self.setup_window()
        
        # ì„¤ì • ê´€ë¦¬ì ì´ˆê¸°í™” (ì•ˆì „í•œ ì´ˆê¸°í™”)
        self.config_manager = ConfigManager()
        self.config_data = {}
        
        # ë„¤ì´ë²„ API ë³€ìˆ˜ë“¤ ì´ˆê¸°í™”
        self.naver_enabled_var = tk.BooleanVar()
        self.naver_client_id_var = tk.StringVar()
        self.naver_client_secret_var = tk.StringVar()
        
        # ë¡œê¹… ì„¤ì •
        self.setup_logging()
        
        # GUI ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”
        self.create_widgets()
        
        # ì„¤ì • ì•ˆì „í•˜ê²Œ ë¡œë“œ
        self.safe_load_settings()
        
        # ì§„í–‰ìƒíƒœ ë³€ìˆ˜
        self.is_running = False
    
    def setup_window(self):
        """ë©”ì¸ ì°½ ì„¤ì •"""
        self.root.title("ğŸ  ì²­ì•½ ë¶„ì–‘ì •ë³´ ìë™í™” ì‹œìŠ¤í…œ v1.0")
        self.root.geometry("800x800")  # ë†’ì´ ì¦ê°€
        self.root.resizable(True, True)
        
        # ì°½ ì•„ì´ì½˜ ì„¤ì • (ì„ íƒì‚¬í•­)
        try:
            # self.root.iconbitmap('icon.ico')  # ì•„ì´ì½˜ íŒŒì¼ì´ ìˆëŠ” ê²½ìš°
            pass
        except:
            pass
        
        # ë©”ì¸ ìŠ¤íƒ€ì¼ ì„¤ì •
        style = ttk.Style()
        style.theme_use('clam')
        
        # ì°½ ë‹«ê¸° ì´ë²¤íŠ¸ ë°”ì¸ë”©
        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)
    
    def setup_logging(self):
        """ë¡œê¹… ì„¤ì •"""
        # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
        log_dir = "logs"
        if not os.path.exists(log_dir):
            os.makedirs(log_dir)
        
        # ë¡œê·¸ íŒŒì¼ëª…
        log_filename = os.path.join(log_dir, f"subscription_system_{datetime.now().strftime('%Y%m%d')}.log")
        
        # ë¡œê¹… ì„¤ì •
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler(log_filename, encoding='utf-8'),
                logging.StreamHandler()
            ]
        )
        
        self.logger = logging.getLogger(__name__)
        self.logger.info("ì²­ì•½ ë¶„ì–‘ì •ë³´ ìë™í™” ì‹œìŠ¤í…œ ì‹œì‘")
    
    def safe_load_settings(self):
        """ì„¤ì • ì•ˆì „í•˜ê²Œ ë¡œë“œ (URL ì¸ì½”ë”© ë¬¸ì œ í•´ê²°)"""
        try:
            self.log_message("ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹œì‘...")
            
            # ì„¤ì • ë¡œë“œ (URL ì¸ì½”ë”© ë¬¸ì œ ìë™ í•´ê²°)
            self.config_data = self.config_manager.load_config()
            
            # UIì— ì„¤ì • ë°˜ì˜
            self.load_config_to_ui_with_naver()
            
        except Exception as e:
            self.log_message(f"âŒ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: {e}")
            self.config_data = self.config_manager._create_default_config()
            messagebox.showerror("ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", 
                               f"ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.\n\nì˜¤ë¥˜: {e}")
    
    def load_config_to_ui_with_naver(self):
        """ì„¤ì • ë°ì´í„°ë¥¼ UIì— ë¡œë“œ (ë„¤ì´ë²„ API í¬í•¨)"""
        try:
            # API ì„¤ì •
            api_config = self.config_data.get('api', {})
            self.api_key_var.set(api_config.get('service_key', ''))
            
            # ë„¤ì´ë²„ API ì„¤ì • ë¡œë“œ
            naver_config = self.config_data.get('naver_api', {})
            self.naver_enabled_var.set(naver_config.get('enabled', False))
            self.naver_client_id_var.set(naver_config.get('client_id', ''))
            self.naver_client_secret_var.set(naver_config.get('client_secret', ''))
            self.toggle_naver_settings()
            
            # ì´ë©”ì¼ ì„¤ì •
            email_config = self.config_data.get('email', {})
            self.sender_email_var.set(email_config.get('sender_email', ''))
            self.app_password_var.set(email_config.get('app_password', ''))
            
            # ìˆ˜ì‹ ì ëª©ë¡ ë¡œë“œ
            self.recipients_listbox.delete(0, tk.END)
            recipients = email_config.get('recipients', [])
            for recipient in recipients:
                if recipient and recipient.strip():
                    self.recipients_listbox.insert(tk.END, recipient.strip())
            
            # ì¹´ì¹´ì˜¤í†¡ ì„¤ì •
            kakao_config = self.config_data.get('kakao', {})
            self.kakao_enabled_var.set(kakao_config.get('enabled', False))
            self.kakao_api_key_var.set(kakao_config.get('api_key', ''))
            self.toggle_kakao_settings()
            
            # ìŠ¤ì¼€ì¤„ ì„¤ì •
            schedule_config = self.config_data.get('schedule', {})
            self.schedule_enabled_var.set(schedule_config.get('enabled', False))
            self.schedule_time_var.set(schedule_config.get('time', '09:00'))
            self.toggle_schedule_settings()
            
            self.log_message("âœ… ì„¤ì • UI ë¡œë“œ ì™„ë£Œ (ë„¤ì´ë²„ API í¬í•¨)")
            
        except Exception as e:
            self.log_message(f"âŒ UI ë¡œë“œ ì˜¤ë¥˜: {e}")
    
    def create_widgets(self):
        """GUI ìœ„ì ¯ ìƒì„±"""
        # ë©”ì¸ í”„ë ˆì„
        main_frame = ttk.Frame(self.root, padding="10")
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        # ê·¸ë¦¬ë“œ ê°€ì¤‘ì¹˜ ì„¤ì •
        self.root.columnconfigure(0, weight=1)
        self.root.rowconfigure(0, weight=1)
        main_frame.columnconfigure(1, weight=1)
        
        current_row = 0
        
        # ì œëª©
        title_label = ttk.Label(main_frame, text="ì²­ì•½ ë¶„ì–‘ì •ë³´ ìë™í™” ì‹œìŠ¤í…œ", 
                               font=('ë§‘ì€ ê³ ë”•', 16, 'bold'))
        title_label.grid(row=current_row, column=0, columnspan=3, pady=(0, 20))
        current_row += 1
        
        # API ì„¤ì • ì„¹ì…˜
        self.create_api_section(main_frame, current_row)
        current_row += 3
        
        # ë„¤ì´ë²„ API ì„¤ì • ì„¹ì…˜ ì¶”ê°€
        self.create_naver_api_section(main_frame, current_row)
        current_row += 4  # ë„¤ì´ë²„ API ì„¹ì…˜ ì¶”ê°€ë¡œ ì¸í•œ í–‰ ìˆ˜ ì¦ê°€
        
        # ì´ë©”ì¼ ì„¤ì • ì„¹ì…˜
        self.create_email_section(main_frame, current_row)
        current_row += 5
        
        # ì¹´ì¹´ì˜¤í†¡ ì„¤ì • ì„¹ì…˜
        self.create_kakao_section(main_frame, current_row)
        current_row += 3
        
        # ì‹¤í–‰ ì˜µì…˜ ì„¹ì…˜
        self.create_execution_section(main_frame, current_row)
        current_row += 3
        
        # ë²„íŠ¼ ì„¹ì…˜ (ê°•í™”ëœ ë²„ì „ ì‚¬ìš©)
        self.create_enhanced_button_section(main_frame, current_row)
        current_row += 3  # ë²„íŠ¼ í–‰ ìˆ˜ ì¦ê°€
        
        # ì§„í–‰ìƒíƒœ ì„¹ì…˜
        self.create_progress_section(main_frame, current_row)
        current_row += 3
        
        # ë¡œê·¸ ì„¹ì…˜
        self.create_log_section(main_frame, current_row)
    
    def create_api_section(self, parent, start_row):
        """API ì„¤ì • ì„¹ì…˜ ìƒì„±"""
        # API ì„¤ì • ë ˆì´ë¸”
        api_label = ttk.Label(parent, text="ğŸ“¡ API ì„¤ì •", font=('ë§‘ì€ ê³ ë”•', 12, 'bold'))
        api_label.grid(row=start_row, column=0, columnspan=3, sticky=tk.W, pady=(10, 5))
        
        # êµ¬ë¶„ì„ 
        separator = ttk.Separator(parent, orient='horizontal')
        separator.grid(row=start_row+1, column=0, columnspan=3, sticky=(tk.W, tk.E), pady=(0, 10))
        
        # ê³µê³µë°ì´í„° ì¸ì¦í‚¤
        ttk.Label(parent, text="ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤:").grid(row=start_row+2, column=0, sticky=tk.W, padx=(20, 5))
        self.api_key_var = tk.StringVar()
        self.api_key_entry = ttk.Entry(parent, textvariable=self.api_key_var, width=40, show="*")
        self.api_key_entry.grid(row=start_row+2, column=1, sticky=(tk.W, tk.E), padx=5)
        
        # API í…ŒìŠ¤íŠ¸ ë²„íŠ¼
        self.test_api_btn = ttk.Button(parent, text="í…ŒìŠ¤íŠ¸", command=self.test_api_connection)
        self.test_api_btn.grid(row=start_row+2, column=2, padx=(5, 0))
    
    def create_naver_api_section(self, parent, start_row):
        """ë„¤ì´ë²„ API ì„¤ì • ì„¹ì…˜ ìƒì„±"""
        # ë„¤ì´ë²„ API ì„¤ì • ë ˆì´ë¸”
        naver_label = ttk.Label(parent, text="ğŸ” ë„¤ì´ë²„ API ì„¤ì • (ì„ íƒì‚¬í•­)", font=('ë§‘ì€ ê³ ë”•', 12, 'bold'))
        naver_label.grid(row=start_row, column=0, columnspan=3, sticky=tk.W, pady=(10, 5))
        
        # êµ¬ë¶„ì„ 
        separator = ttk.Separator(parent, orient='horizontal')
        separator.grid(row=start_row+1, column=0, columnspan=3, sticky=(tk.W, tk.E), pady=(0, 10))
        
        # ë„¤ì´ë²„ API í™œì„±í™” ì²´í¬ë°•ìŠ¤
        self.naver_enabled_check = ttk.Checkbutton(parent, text="ë„¤ì´ë²„ API ì‚¬ìš©", 
                                                variable=self.naver_enabled_var,
                                                command=self.toggle_naver_settings)
        self.naver_enabled_check.grid(row=start_row+2, column=0, sticky=tk.W, padx=(20, 5))
        
        # Client ID
        ttk.Label(parent, text="Client ID:").grid(row=start_row+2, column=1, sticky=tk.W, padx=(20, 5))
        self.naver_client_id_entry = ttk.Entry(parent, textvariable=self.naver_client_id_var, width=25)
        self.naver_client_id_entry.grid(row=start_row+2, column=2, sticky=(tk.W, tk.E), padx=5)
        
        # Client Secret
        ttk.Label(parent, text="Client Secret:").grid(row=start_row+3, column=0, sticky=tk.W, padx=(20, 5))
        self.naver_client_secret_entry = ttk.Entry(parent, textvariable=self.naver_client_secret_var, width=25, show="*")
        self.naver_client_secret_entry.grid(row=start_row+3, column=1, columnspan=2, sticky=(tk.W, tk.E), padx=5)
        
        # ì´ˆê¸°ì—ëŠ” ë¹„í™œì„±í™”
        self.naver_client_id_entry.config(state='disabled')
        self.naver_client_secret_entry.config(state='disabled')

    def toggle_naver_settings(self):
        """ë„¤ì´ë²„ API ì„¤ì • í™œì„±í™”/ë¹„í™œì„±í™”"""
        if self.naver_enabled_var.get():
            self.naver_client_id_entry.config(state='normal')
            self.naver_client_secret_entry.config(state='normal')
        else:
            self.naver_client_id_entry.config(state='disabled')
            self.naver_client_secret_entry.config(state='disabled')
    
    def create_email_section(self, parent, start_row):
        """ì´ë©”ì¼ ì„¤ì • ì„¹ì…˜ ìƒì„±"""
        # ì´ë©”ì¼ ì„¤ì • ë ˆì´ë¸”
        email_label = ttk.Label(parent, text="ğŸ“§ ì´ë©”ì¼ ì„¤ì •", font=('ë§‘ì€ ê³ ë”•', 12, 'bold'))
        email_label.grid(row=start_row, column=0, columnspan=3, sticky=tk.W, pady=(10, 5))
        
        # êµ¬ë¶„ì„ 
        separator = ttk.Separator(parent, orient='horizontal')
        separator.grid(row=start_row+1, column=0, columnspan=3, sticky=(tk.W, tk.E), pady=(0, 10))
        
        # ë°œì‹ ì ì´ë©”ì¼
        ttk.Label(parent, text="ë°œì‹ ì ì´ë©”ì¼:").grid(row=start_row+2, column=0, sticky=tk.W, padx=(20, 5))
        self.sender_email_var = tk.StringVar()
        self.sender_email_entry = ttk.Entry(parent, textvariable=self.sender_email_var, width=40)
        self.sender_email_entry.grid(row=start_row+2, column=1, columnspan=2, sticky=(tk.W, tk.E), padx=5)
        
        # ì•± ë¹„ë°€ë²ˆí˜¸
        ttk.Label(parent, text="Gmail ì•± ë¹„ë°€ë²ˆí˜¸:").grid(row=start_row+3, column=0, sticky=tk.W, padx=(20, 5))
        self.app_password_var = tk.StringVar()
        self.app_password_entry = ttk.Entry(parent, textvariable=self.app_password_var, width=40, show="*")
        self.app_password_entry.grid(row=start_row+3, column=1, sticky=(tk.W, tk.E), padx=5)
        
        # ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ ë²„íŠ¼
        self.test_email_btn = ttk.Button(parent, text="í…ŒìŠ¤íŠ¸", command=self.test_email_connection)
        self.test_email_btn.grid(row=start_row+3, column=2, padx=(5, 0))
        
        # ìˆ˜ì‹ ì ì´ë©”ì¼
        ttk.Label(parent, text="ìˆ˜ì‹ ì ì´ë©”ì¼:").grid(row=start_row+4, column=0, sticky=tk.W, padx=(20, 5))
        
        # ìˆ˜ì‹ ì í”„ë ˆì„
        recipients_frame = ttk.Frame(parent)
        recipients_frame.grid(row=start_row+4, column=1, columnspan=2, sticky=(tk.W, tk.E), padx=5)
        recipients_frame.columnconfigure(0, weight=1)
        
        self.recipients_var = tk.StringVar()
        self.recipients_entry = ttk.Entry(recipients_frame, textvariable=self.recipients_var, width=35)
        self.recipients_entry.grid(row=0, column=0, sticky=(tk.W, tk.E), padx=(0, 5))
        
        ttk.Button(recipients_frame, text="+ì¶”ê°€", command=self.add_recipient, width=8).grid(row=0, column=1)
        
        # ìˆ˜ì‹ ì ëª©ë¡
        self.recipients_listbox = tk.Listbox(parent, height=3)
        self.recipients_listbox.grid(row=start_row+5, column=1, columnspan=2, sticky=(tk.W, tk.E), padx=5, pady=5)
        self.recipients_listbox.bind('<Double-Button-1>', self.remove_recipient)
    
    def create_kakao_section(self, parent, start_row):
        """ì¹´ì¹´ì˜¤í†¡ ì„¤ì • ì„¹ì…˜ ìƒì„±"""
        # ì¹´ì¹´ì˜¤í†¡ ì„¤ì • ë ˆì´ë¸”
        kakao_label = ttk.Label(parent, text="ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ì„¤ì • (ì„ íƒì‚¬í•­)", font=('ë§‘ì€ ê³ ë”•', 12, 'bold'))
        kakao_label.grid(row=start_row, column=0, columnspan=3, sticky=tk.W, pady=(10, 5))
        
        # êµ¬ë¶„ì„ 
        separator = ttk.Separator(parent, orient='horizontal')
        separator.grid(row=start_row+1, column=0, columnspan=3, sticky=(tk.W, tk.E), pady=(0, 10))
        
        # ì¹´ì¹´ì˜¤í†¡ í™œì„±í™” ì²´í¬ë°•ìŠ¤
        self.kakao_enabled_var = tk.BooleanVar()
        self.kakao_enabled_check = ttk.Checkbutton(parent, text="ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼ ì‚¬ìš©", 
                                                  variable=self.kakao_enabled_var,
                                                  command=self.toggle_kakao_settings)
        self.kakao_enabled_check.grid(row=start_row+2, column=0, columnspan=2, sticky=tk.W, padx=(20, 5))
        
        # ì¹´ì¹´ì˜¤í†¡ API í‚¤
        ttk.Label(parent, text="ì¹´ì¹´ì˜¤í†¡ API í‚¤:").grid(row=start_row+2, column=1, sticky=tk.W, padx=(100, 5))
        self.kakao_api_key_var = tk.StringVar()
        self.kakao_api_key_entry = ttk.Entry(parent, textvariable=self.kakao_api_key_var, width=25, show="*")
        self.kakao_api_key_entry.grid(row=start_row+2, column=2, sticky=(tk.W, tk.E), padx=5)
        
        # ì´ˆê¸°ì—ëŠ” ë¹„í™œì„±í™”
        self.kakao_api_key_entry.config(state='disabled')
    
    def create_execution_section(self, parent, start_row):
        """ì‹¤í–‰ ì˜µì…˜ ì„¹ì…˜ ìƒì„±"""
        # ì‹¤í–‰ ì˜µì…˜ ë ˆì´ë¸”
        exec_label = ttk.Label(parent, text="âš™ï¸ ì‹¤í–‰ ì˜µì…˜", font=('ë§‘ì€ ê³ ë”•', 12, 'bold'))
        exec_label.grid(row=start_row, column=0, columnspan=3, sticky=tk.W, pady=(10, 5))
        
        # êµ¬ë¶„ì„ 
        separator = ttk.Separator(parent, orient='horizontal')
        separator.grid(row=start_row+1, column=0, columnspan=3, sticky=(tk.W, tk.E), pady=(0, 10))
        
        # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ì²´í¬ë°•ìŠ¤
        self.schedule_enabled_var = tk.BooleanVar()
        self.schedule_enabled_check = ttk.Checkbutton(parent, text="ìŠ¤ì¼€ì¤„ ì‹¤í–‰", 
                                                     variable=self.schedule_enabled_var,
                                                     command=self.toggle_schedule_settings)
        self.schedule_enabled_check.grid(row=start_row+2, column=0, sticky=tk.W, padx=(20, 5))
        
        # ì‹¤í–‰ ì‹œê°„
        ttk.Label(parent, text="ì‹¤í–‰ ì‹œê°„:").grid(row=start_row+2, column=1, sticky=tk.W, padx=(20, 5))
        self.schedule_time_var = tk.StringVar(value="09:00")
        self.schedule_time_entry = ttk.Entry(parent, textvariable=self.schedule_time_var, width=10)
        self.schedule_time_entry.grid(row=start_row+2, column=2, sticky=tk.W, padx=5)
        self.schedule_time_entry.config(state='disabled')
        
        ttk.Label(parent, text="ë§¤ì¼").grid(row=start_row+2, column=2, sticky=tk.W, padx=(80, 5))
    
    def create_enhanced_button_section(self, parent, start_row):
        """ê°•í™”ëœ ë²„íŠ¼ ì„¹ì…˜ (ë„¤ì´ë²„ API ê¸°ëŠ¥ í¬í•¨)"""
        # ë²„íŠ¼ í”„ë ˆì„
        button_frame = ttk.Frame(parent)
        button_frame.grid(row=start_row, column=0, columnspan=3, pady=20)
        
        # ì²« ë²ˆì§¸ ì¤„ ë²„íŠ¼ë“¤
        self.run_btn = ttk.Button(button_frame, text="ğŸš€ ì‹¤í–‰", command=self.run_system, 
                                style='Accent.TButton', width=12)
        self.run_btn.grid(row=0, column=0, padx=5)
        
        ttk.Button(button_frame, text="ğŸ’¾ ì„¤ì •ì €ì¥", command=self.save_settings_with_naver, width=12).grid(row=0, column=1, padx=5)
        ttk.Button(button_frame, text="ğŸ“ ì„¤ì •ë¶ˆëŸ¬ì˜¤ê¸°", command=self.safe_load_settings, width=12).grid(row=0, column=2, padx=5)
        ttk.Button(button_frame, text="ğŸ“Š ì—‘ì…€í…ŒìŠ¤íŠ¸", command=self.test_excel_creation, width=12).grid(row=0, column=3, padx=5)
        
        # ë‘ ë²ˆì§¸ ì¤„ - ë„¤ì´ë²„ API ê¸°ëŠ¥ë“¤
        ttk.Button(button_frame, text="ğŸ“° ë‰´ìŠ¤ê²€ìƒ‰", command=self.search_related_news, width=12).grid(row=1, column=0, padx=5, pady=5)
        ttk.Button(button_frame, text="ğŸ“ˆ ì‹œì¥ë™í–¥", command=self.analyze_market_trends, width=12).grid(row=1, column=1, padx=5, pady=5)
        ttk.Button(button_frame, text="ğŸ” ì¢…í•©ë¶„ì„", command=self.comprehensive_analysis, width=12).grid(row=1, column=2, padx=5, pady=5)
        ttk.Button(button_frame, text="ğŸ”§ ì„¤ì •ìˆ˜ì •", command=self.fix_config_file, width=12).grid(row=1, column=3, padx=5, pady=5)
        
        # ì„¸ ë²ˆì§¸ ì¤„
        ttk.Button(button_frame, text="âŒ ì¢…ë£Œ", command=self.on_closing, width=12).grid(row=2, column=2, padx=5, pady=5)
    
    def create_progress_section(self, parent, start_row):
        """ì§„í–‰ìƒíƒœ ì„¹ì…˜ ìƒì„±"""
        # ì§„í–‰ìƒíƒœ ë ˆì´ë¸”
        ttk.Label(parent, text="ğŸ“Š ì§„í–‰ìƒíƒœ:", font=('ë§‘ì€ ê³ ë”•', 10, 'bold')).grid(row=start_row, column=0, sticky=tk.W, pady=(10, 5))
        
        # ì§„í–‰ë°”
        self.progress_var = tk.DoubleVar()
        self.progress_bar = ttk.Progressbar(parent, variable=self.progress_var, maximum=100)
        self.progress_bar.grid(row=start_row+1, column=0, columnspan=3, sticky=(tk.W, tk.E), padx=(20, 0), pady=5)
        
        # ìƒíƒœ ë ˆì´ë¸”
        self.status_var = tk.StringVar(value="ì¤€ë¹„ ì™„ë£Œ")
        self.status_label = ttk.Label(parent, textvariable=self.status_var)
        self.status_label.grid(row=start_row+2, column=0, columnspan=3, sticky=tk.W, padx=(20, 0))
    
    def create_log_section(self, parent, start_row):
        """ë¡œê·¸ ì„¹ì…˜ ìƒì„±"""
        # ë¡œê·¸ ë ˆì´ë¸”
        ttk.Label(parent, text="ğŸ“ ì‹¤í–‰ ë¡œê·¸:", font=('ë§‘ì€ ê³ ë”•', 10, 'bold')).grid(row=start_row, column=0, sticky=tk.W, pady=(10, 5))
        
        # ë¡œê·¸ í…ìŠ¤íŠ¸ ì˜ì—­
        self.log_text = scrolledtext.ScrolledText(parent, height=8, width=80)
        self.log_text.grid(row=start_row+1, column=0, columnspan=3, sticky=(tk.W, tk.E, tk.N, tk.S), padx=(20, 0), pady=5)
        
        # ë¡œê·¸ ì§€ìš°ê¸° ë²„íŠ¼
        ttk.Button(parent, text="ë¡œê·¸ ì§€ìš°ê¸°", command=self.clear_log).grid(row=start_row+2, column=2, sticky=tk.E, pady=5)
    
    def fix_config_file(self):
        """ì„¤ì • íŒŒì¼ URL ì¸ì½”ë”© ë¬¸ì œ ìˆ˜ì •"""
        try:
            if self.config_manager.fix_url_encoding_issues():
                messagebox.showinfo("ìˆ˜ì • ì™„ë£Œ", "ì„¤ì • íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!")
                self.log_message("âœ… ì„¤ì • íŒŒì¼ ìˆ˜ì • ì™„ë£Œ")
                # ì„¤ì • ë‹¤ì‹œ ë¡œë“œ
                self.safe_load_settings()
            else:
                messagebox.showinfo("ìˆ˜ì • ì™„ë£Œ", "URL ì¸ì½”ë”© ë¬¸ì œê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                
        except Exception as e:
            error_msg = f"ì„¤ì • íŒŒì¼ ìˆ˜ì • ì˜¤ë¥˜: {e}"
            messagebox.showerror("ìˆ˜ì • ì‹¤íŒ¨", error_msg)
            self.log_message(f"âŒ {error_msg}")
    
    def toggle_kakao_settings(self):
        """ì¹´ì¹´ì˜¤í†¡ ì„¤ì • í™œì„±í™”/ë¹„í™œì„±í™”"""
        if self.kakao_enabled_var.get():
            self.kakao_api_key_entry.config(state='normal')
        else:
            self.kakao_api_key_entry.config(state='disabled')
    
    def toggle_schedule_settings(self):
        """ìŠ¤ì¼€ì¤„ ì„¤ì • í™œì„±í™”/ë¹„í™œì„±í™”"""
        if self.schedule_enabled_var.get():
            self.schedule_time_entry.config(state='normal')
        else:
            self.schedule_time_entry.config(state='disabled')
    
    def add_recipient(self):
        """ìˆ˜ì‹ ì ì´ë©”ì¼ ì¶”ê°€"""
        email = self.recipients_var.get().strip()
        if email:
            # ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
            import re
            email_pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
            if re.match(email_pattern, email):
                # ì¤‘ë³µ ì²´í¬
                existing_emails = [self.recipients_listbox.get(i) for i in range(self.recipients_listbox.size())]
                if email not in existing_emails:
                    self.recipients_listbox.insert(tk.END, email)
                    self.recipients_var.set('')
                    self.log_message(f"ìˆ˜ì‹ ì ì¶”ê°€: {email}")
                else:
                    messagebox.showwarning("ì¤‘ë³µ ì´ë©”ì¼", "ì´ë¯¸ ì¶”ê°€ëœ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.")
            else:
                messagebox.showerror("ì´ë©”ì¼ í˜•ì‹ ì˜¤ë¥˜", "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            messagebox.showwarning("ì…ë ¥ ì˜¤ë¥˜", "ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    
    def remove_recipient(self, event):
        """ìˆ˜ì‹ ì ì´ë©”ì¼ ì œê±° (ë”ë¸”í´ë¦­)"""
        selection = self.recipients_listbox.curselection()
        if selection:
            email = self.recipients_listbox.get(selection[0])
            self.recipients_listbox.delete(selection[0])
            self.log_message(f"ìˆ˜ì‹ ì ì œê±°: {email}")
    
    def test_api_connection(self):
        """API ì—°ê²° í…ŒìŠ¤íŠ¸"""
        api_key = self.api_key_var.get().strip()
        if not api_key:
            messagebox.showerror("ì˜¤ë¥˜", "ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            return
        
        self.log_message("API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...")
        self.test_api_btn.config(state='disabled')
        
        def test_thread():
            try:
                api = PublicDataAPI(api_key)
                success, message = api.test_connection()
                
                self.root.after(0, lambda: self.show_test_result("API ì—°ê²° í…ŒìŠ¤íŠ¸", success, message))
            except Exception as e:
                self.root.after(0, lambda: self.show_test_result("API ì—°ê²° í…ŒìŠ¤íŠ¸", False, str(e)))
            finally:
                self.root.after(0, lambda: self.test_api_btn.config(state='normal'))
        
        threading.Thread(target=test_thread, daemon=True).start()
    
    def test_email_connection(self):
        """ì´ë©”ì¼ ì—°ê²° í…ŒìŠ¤íŠ¸"""
        sender_email = self.sender_email_var.get().strip()
        app_password = self.app_password_var.get().strip()
        
        if not sender_email or not app_password:
            messagebox.showerror("ì˜¤ë¥˜", "ë°œì‹ ì ì´ë©”ì¼ê³¼ ì•± ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            return
        
        self.log_message("ì´ë©”ì¼ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...")
        self.test_email_btn.config(state='disabled')
        
        def test_thread():
            try:
                email_sender = EmailSender()
                success, message = email_sender.test_connection(sender_email, app_password)
                
                if success:
                    # í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ ì „ì†¡
                    success, message = email_sender.send_test_email(sender_email, app_password, sender_email)
                
                self.root.after(0, lambda: self.show_test_result("ì´ë©”ì¼ ì—°ê²° í…ŒìŠ¤íŠ¸", success, message))
            except Exception as e:
                self.root.after(0, lambda: self.show_test_result("ì´ë©”ì¼ ì—°ê²° í…ŒìŠ¤íŠ¸", False, str(e)))
            finally:
                self.root.after(0, lambda: self.test_email_btn.config(state='normal'))
        
        threading.Thread(target=test_thread, daemon=True).start()
    
    def test_excel_creation(self):
        """ì—‘ì…€ íŒŒì¼ ìƒì„± í…ŒìŠ¤íŠ¸"""
        self.log_message("ì—‘ì…€ íŒŒì¼ ìƒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘...")
        
        try:
            excel_handler = ExcelHandler()
            test_file = excel_handler.create_test_excel()
            
            messagebox.showinfo("í…ŒìŠ¤íŠ¸ ì„±ê³µ", f"í…ŒìŠ¤íŠ¸ ì—‘ì…€ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤:\n{test_file}")
            self.log_message(f"í…ŒìŠ¤íŠ¸ ì—‘ì…€ íŒŒì¼ ìƒì„± ì™„ë£Œ: {test_file}")
            
            # íŒŒì¼ ì—´ê¸° ì˜µì…˜
            if messagebox.askyesno("íŒŒì¼ ì—´ê¸°", "ìƒì„±ëœ íŒŒì¼ì„ ì—´ì–´ë³´ì‹œê² ìŠµë‹ˆê¹Œ?"):
                os.startfile(test_file)
                
        except Exception as e:
            error_msg = f"ì—‘ì…€ íŒŒì¼ ìƒì„± í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {str(e)}"
            messagebox.showerror("í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨", error_msg)
            self.log_message(error_msg)
    
    def show_test_result(self, test_name: str, success: bool, message: str):
        """í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ"""
        if success:
            messagebox.showinfo(f"{test_name} ì„±ê³µ", message)
            self.log_message(f"âœ… {test_name} ì„±ê³µ: {message}")
        else:
            messagebox.showerror(f"{test_name} ì‹¤íŒ¨", message)
            self.log_message(f"âŒ {test_name} ì‹¤íŒ¨: {message}")
    
    def save_settings_with_naver(self):
        """ì„¤ì • ì €ì¥ (ë„¤ì´ë²„ API í¬í•¨)"""
        try:
            # ìˆ˜ì‹ ì ëª©ë¡ ìˆ˜ì§‘
            recipients = [self.recipients_listbox.get(i) for i in range(self.recipients_listbox.size())]
            
            config_data = {
                'api': {
                    'service_key': self.api_key_var.get().strip(),
                    'max_rows': 50
                },
                'naver_api': {
                    'enabled': self.naver_enabled_var.get(),
                    'client_id': self.naver_client_id_var.get().strip(),
                    'client_secret': self.naver_client_secret_var.get().strip()
                },
                'email': {
                    'sender_email': self.sender_email_var.get().strip(),
                    'app_password': self.app_password_var.get().strip(),
                    'recipients': recipients
                },
                'kakao': {
                    'enabled': self.kakao_enabled_var.get(),
                    'api_key': self.kakao_api_key_var.get().strip()
                },
                'schedule': {
                    'enabled': self.schedule_enabled_var.get(),
                    'time': self.schedule_time_var.get().strip()
                }
            }
            
            # ì„¤ì • ìœ íš¨ì„± ê²€ì¦
            is_valid, errors = self.config_manager.validate_config(config_data)
            if not is_valid:
                error_message = "ì„¤ì • ì˜¤ë¥˜:\n" + "\n".join(errors)
                messagebox.showerror("ì„¤ì • ì €ì¥ ì‹¤íŒ¨", error_message)
                return
            
            # ì„¤ì • ì €ì¥
            if self.config_manager.save_config(config_data):
                messagebox.showinfo("ì„¤ì • ì €ì¥", "ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
                self.log_message("ì„¤ì • ì €ì¥ ì™„ë£Œ (ë„¤ì´ë²„ API í¬í•¨)")
                self.config_data = config_data
            else:
                messagebox.showerror("ì„¤ì • ì €ì¥ ì‹¤íŒ¨", "ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                
        except Exception as e:
            error_msg = f"ì„¤ì • ì €ì¥ ì˜¤ë¥˜: {str(e)}"
            messagebox.showerror("ì˜¤ë¥˜", error_msg)
            self.log_message(error_msg)
    
    def search_related_news(self):
        """ê´€ë ¨ ë‰´ìŠ¤ ê²€ìƒ‰"""
        if not self.naver_enabled_var.get():
            messagebox.showwarning("ë„¤ì´ë²„ API", "ë„¤ì´ë²„ APIê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
            return
        
        if not self.naver_client_id_var.get() or not self.naver_client_secret_var.get():
            messagebox.showerror("ì„¤ì • ì˜¤ë¥˜", "ë„¤ì´ë²„ API í´ë¼ì´ì–¸íŠ¸ IDì™€ Secretì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            return
        
        self.log_message("ê´€ë ¨ ë‰´ìŠ¤ ê²€ìƒ‰ ì‹œì‘...")
        
        def search_thread():
            try:
                from api.subscription_with_naver import SubscriptionNaverIntegration
                
                integration = SubscriptionNaverIntegration(
                    self.naver_client_id_var.get(),
                    self.naver_client_secret_var.get()
                )
                
                # ìƒ˜í”Œ ê²€ìƒ‰ (ì‹¤ì œë¡œëŠ” í˜„ì¬ ë¶„ì–‘ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ)
                news_results = integration.search_related_news("ë¶„ì–‘", "ì„œìš¸")
                
                def show_results():
                    if news_results:
                        result_window = tk.Toplevel(self.root)
                        result_window.title("ê´€ë ¨ ë‰´ìŠ¤ ê²€ìƒ‰ ê²°ê³¼")
                        result_window.geometry("800x600")
                        
                        # ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ í…ìŠ¤íŠ¸ ìœ„ì ¯
                        text_widget = scrolledtext.ScrolledText(result_window, wrap=tk.WORD)
                        text_widget.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
                        
                        # ê²°ê³¼ í‘œì‹œ
                        text_widget.insert(tk.END, f"ğŸ“° ê´€ë ¨ ë‰´ìŠ¤ ê²€ìƒ‰ ê²°ê³¼ ({len(news_results)}ê±´)\n")
                        text_widget.insert(tk.END, "="*60 + "\n\n")
                        
                        for i, news in enumerate(news_results[:10], 1):
                            text_widget.insert(tk.END, f"{i}. {news.get('title', 'N/A')}\n")
                            text_widget.insert(tk.END, f"   ğŸ“… {news.get('pubDate', 'N/A')}\n")
                            text_widget.insert(tk.END, f"   ğŸ“ {news.get('description', 'N/A')[:100]}...\n")
                            text_widget.insert(tk.END, f"   ğŸ”— {news.get('link', 'N/A')}\n\n")
                        
                        text_widget.config(state=tk.DISABLED)
                        
                        self.log_message(f"ë‰´ìŠ¤ ê²€ìƒ‰ ì™„ë£Œ: {len(news_results)}ê±´")
                    else:
                        messagebox.showinfo("ê²€ìƒ‰ ê²°ê³¼", "ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                
                self.root.after(0, show_results)
                
            except Exception as e:
                error_msg = f"ë‰´ìŠ¤ ê²€ìƒ‰ ì˜¤ë¥˜: {str(e)}"
                self.root.after(0, lambda: messagebox.showerror("ì˜¤ë¥˜", error_msg))
                self.root.after(0, lambda: self.log_message(f"âŒ {error_msg}"))
        
        threading.Thread(target=search_thread, daemon=True).start()

    def analyze_market_trends(self):
        """ì‹œì¥ ë™í–¥ ë¶„ì„"""
        if not self.naver_enabled_var.get():
            messagebox.showwarning("ë„¤ì´ë²„ API", "ë„¤ì´ë²„ APIê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
            return
        
        # ì§€ì—­ ì„ íƒ ëŒ€í™”ìƒì
        regions = ["ì„œìš¸", "ê²½ê¸°", "ì¸ì²œ", "ë¶€ì‚°", "ëŒ€êµ¬", "ê´‘ì£¼", "ëŒ€ì „", "ìš¸ì‚°", "ì„¸ì¢…"]
        
        region_window = tk.Toplevel(self.root)
        region_window.title("ì§€ì—­ ì„ íƒ")
        region_window.geometry("300x200")
        region_window.transient(self.root)
        region_window.grab_set()
        
        tk.Label(region_window, text="ë¶„ì„í•  ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”:", font=('ë§‘ì€ ê³ ë”•', 12)).pack(pady=10)
        
        selected_region = tk.StringVar(value=regions[0])
        
        for region in regions:
            tk.Radiobutton(region_window, text=region, variable=selected_region, value=region).pack(anchor=tk.W, padx=20)
        
        def start_analysis():
            region = selected_region.get()
            region_window.destroy()
            
            self.log_message(f"{region} ì§€ì—­ ì‹œì¥ ë™í–¥ ë¶„ì„ ì‹œì‘...")
            
            def analysis_thread():
                try:
                    from api.subscription_with_naver import SubscriptionNaverIntegration
                    
                    integration = SubscriptionNaverIntegration(
                        self.naver_client_id_var.get(),
                        self.naver_client_secret_var.get()
                    )
                    
                    trends = integration.search_market_trends(region)
                    
                    def show_trends():
                        trend_window = tk.Toplevel(self.root)
                        trend_window.title(f"{region} ì‹œì¥ ë™í–¥ ë¶„ì„")
                        trend_window.geometry("600x500")
                        
                        text_widget = scrolledtext.ScrolledText(trend_window, wrap=tk.WORD)
                        text_widget.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
                        
                        # ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                        text_widget.insert(tk.END, f"ğŸ“ˆ {region} ì§€ì—­ ì‹œì¥ ë™í–¥ ë¶„ì„\n")
                        text_widget.insert(tk.END, "="*50 + "\n\n")
                        text_widget.insert(tk.END, f"ğŸ“Š ë¶„ì„ ì¼ì‹œ: {trends.get('analysis_date', 'N/A')}\n")
                        text_widget.insert(tk.END, f"ğŸ“° ë‰´ìŠ¤ ê±´ìˆ˜: {trends.get('news_count', 0)}ê±´\n")
                        text_widget.insert(tk.END, f"ğŸ“ ë¸”ë¡œê·¸ ê±´ìˆ˜: {trends.get('blog_count', 0)}ê±´\n\n")
                        
                        # ì£¼ìš” í‚¤ì›Œë“œ
                        keywords = trends.get('market_keywords', [])
                        if keywords:
                            text_widget.insert(tk.END, "ğŸ”‘ ì£¼ìš” í‚¤ì›Œë“œ:\n")
                            text_widget.insert(tk.END, f"   {', '.join(keywords[:10])}\n\n")
                        
                        # ìµœì‹  ë‰´ìŠ¤
                        latest_news = trends.get('latest_news', [])
                        if latest_news:
                            text_widget.insert(tk.END, "ğŸ“° ìµœì‹  ê´€ë ¨ ë‰´ìŠ¤:\n")
                            for i, news in enumerate(latest_news[:5], 1):
                                text_widget.insert(tk.END, f"{i}. {news.get('title', 'N/A')}\n")
                                text_widget.insert(tk.END, f"   ğŸ“… {news.get('pubDate', 'N/A')}\n\n")
                        
                        text_widget.config(state=tk.DISABLED)
                        
                        self.log_message(f"{region} ì‹œì¥ ë™í–¥ ë¶„ì„ ì™„ë£Œ")
                    
                    self.root.after(0, show_trends)
                    
                except Exception as e:
                    error_msg = f"ì‹œì¥ ë™í–¥ ë¶„ì„ ì˜¤ë¥˜: {str(e)}"
                    self.root.after(0, lambda: messagebox.showerror("ì˜¤ë¥˜", error_msg))
            
            threading.Thread(target=analysis_thread, daemon=True).start()
        
        tk.Button(region_window, text="ë¶„ì„ ì‹œì‘", command=start_analysis, 
                bg='#007ACC', fg='white', font=('ë§‘ì€ ê³ ë”•', 11)).pack(pady=20)

    def comprehensive_analysis(self):
        """ì¢…í•© ë¶„ì„"""
        if not self.naver_enabled_var.get():
            messagebox.showwarning("ë„¤ì´ë²„ API", "ë„¤ì´ë²„ APIê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
            return
        
        self.log_message("ì¢…í•© ì‹œì¥ ë¶„ì„ ì‹œì‘...")
        
        def analysis_thread():
            try:
                from api.subscription_with_naver import SubscriptionNaverIntegration
                
                integration = SubscriptionNaverIntegration(
                    self.naver_client_id_var.get(),
                    self.naver_client_secret_var.get()
                )
                
                # ìƒ˜í”Œ ë°ì´í„°ë¡œ ì¢…í•© ë¶„ì„
                sample_data = {
                    'apt': [{'ì£¼íƒëª…': 'ìƒ˜í”Œ ì•„íŒŒíŠ¸', 'ê³µê¸‰ì§€ì—­': 'ì„œìš¸'}],
                    'officetel': []
                }
                
                report = integration.get_comprehensive_market_report(sample_data)
                
                def show_report():
                    report_window = tk.Toplevel(self.root)
                    report_window.title("ì¢…í•© ì‹œì¥ ë¶„ì„ ë³´ê³ ì„œ")
                    report_window.geometry("800x700")
                    
                    text_widget = scrolledtext.ScrolledText(report_window, wrap=tk.WORD)
                    text_widget.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
                    
                    # ë³´ê³ ì„œ ë‚´ìš© í‘œì‹œ
                    text_widget.insert(tk.END, "ğŸ“Š ì¢…í•© ì‹œì¥ ë¶„ì„ ë³´ê³ ì„œ\n")
                    text_widget.insert(tk.END, "="*60 + "\n\n")
                    text_widget.insert(tk.END, f"ğŸ“… ë³´ê³ ì„œ ì‘ì„±ì¼: {report.get('report_date', 'N/A')}\n\n")
                    
                    # ìš”ì•½ ì •ë³´
                    summary = report.get('summary', {})
                    text_widget.insert(tk.END, "ğŸ“‹ ìš”ì•½ ì •ë³´:\n")
                    text_widget.insert(tk.END, f"   â€¢ ì´ ë¶„ì–‘ ê±´ìˆ˜: {summary.get('total_subscriptions', 0)}ê±´\n")
                    text_widget.insert(tk.END, f"   â€¢ ë¶„ì„ ì§€ì—­ ìˆ˜: {len(summary.get('analyzed_regions', []))}ê°œ\n")
                    
                    hot_keywords = summary.get('hot_keywords', [])
                    if hot_keywords:
                        text_widget.insert(tk.END, f"   â€¢ í•« í‚¤ì›Œë“œ: {', '.join(hot_keywords[:5])}\n\n")
                    
                    # ì§€ì—­ë³„ ë¶„ì„
                    regional_analysis = report.get('regional_analysis', {})
                    if regional_analysis:
                        text_widget.insert(tk.END, "ğŸŒ ì§€ì—­ë³„ ë¶„ì„:\n")
                        for region, data in regional_analysis.items():
                            text_widget.insert(tk.END, f"\nğŸ“ {region}:\n")
                            text_widget.insert(tk.END, f"   ë‰´ìŠ¤: {data.get('news_count', 0)}ê±´\n")
                            text_widget.insert(tk.END, f"   ë¸”ë¡œê·¸: {data.get('blog_count', 0)}ê±´\n")
                    
                    text_widget.config(state=tk.DISABLED)
                    
                    self.log_message("ì¢…í•© ë¶„ì„ ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ")
                
                self.root.after(0, show_report)
                
            except Exception as e:
                error_msg = f"ì¢…í•© ë¶„ì„ ì˜¤ë¥˜: {str(e)}"
                self.root.after(0, lambda: messagebox.showerror("ì˜¤ë¥˜", error_msg))
        
        threading.Thread(target=analysis_thread, daemon=True).start()
    
    def run_system(self):
        """ì‹œìŠ¤í…œ ì‹¤í–‰"""
        if self.is_running:
            messagebox.showwarning("ì‹¤í–‰ ì¤‘", "ì‹œìŠ¤í…œì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.")
            return
        
        # ì„¤ì • ê²€ì¦
        recipients = [self.recipients_listbox.get(i) for i in range(self.recipients_listbox.size())]
        
        if not self.api_key_var.get().strip():
            messagebox.showerror("ì„¤ì • ì˜¤ë¥˜", "ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
            return
        
        if not self.sender_email_var.get().strip() or not self.app_password_var.get().strip():
            messagebox.showerror("ì„¤ì • ì˜¤ë¥˜", "ì´ë©”ì¼ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.")
            return
        
        if not recipients:
            messagebox.showerror("ì„¤ì • ì˜¤ë¥˜", "ìˆ˜ì‹ ì ì´ë©”ì¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.")
            return
        
        self.log_message("=== ì²­ì•½ ë¶„ì–‘ì •ë³´ ìˆ˜ì§‘ ì‹œì‘ ===")
        self.is_running = True
        self.run_btn.config(state='disabled', text='ì‹¤í–‰ ì¤‘...')
        
        # ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰
        threading.Thread(target=self._run_system_thread, daemon=True).start()
    
    def _run_system_thread(self):
        """ì‹œìŠ¤í…œ ì‹¤í–‰ ìŠ¤ë ˆë“œ"""
        try:
            # ì§„í–‰ìƒíƒœ ì—…ë°ì´íŠ¸
            self.update_progress(10, "API ì—°ê²° ì¤‘...")
            
            # API ì´ˆê¸°í™”
            api = PublicDataAPI(self.api_key_var.get().strip())
            
            self.update_progress(20, "ë¶„ì–‘ì •ë³´ ìˆ˜ì§‘ ì¤‘...")
            
            # ë¶„ì–‘ì •ë³´ ìˆ˜ì§‘
            data = api.get_comprehensive_data(max_rows=50)
            
            self.update_progress(50, "ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘...")
            
            # ì—‘ì…€ íŒŒì¼ ìƒì„±
            excel_handler = ExcelHandler()
            excel_file = excel_handler.create_excel_file(data)
            
            self.update_progress(70, "ì´ë©”ì¼ ì „ì†¡ ì¤‘...")
            
            # ì´ë©”ì¼ ì „ì†¡
            email_sender = EmailSender()
            recipients = [self.recipients_listbox.get(i) for i in range(self.recipients_listbox.size())]
            
            success, message = email_sender.send_subscription_email(
                self.sender_email_var.get().strip(),
                self.app_password_var.get().strip(),
                recipients,
                excel_file,
                data
            )
            
            self.update_progress(90, "ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼ ì „ì†¡ ì¤‘...")
            
            # ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼ (ì˜µì…˜)
            if self.kakao_enabled_var.get() and self.kakao_api_key_var.get().strip():
                kakao_api = create_kakao_api(self.kakao_api_key_var.get().strip(), True)
                kakao_success, kakao_message = kakao_api.send_subscription_notification(data)
                self.root.after(0, lambda: self.log_message(f"ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼: {kakao_message}"))
            
            self.update_progress(100, "ì™„ë£Œ!")
            
            # ê²°ê³¼ í‘œì‹œ
            total_count = sum(len(items) for items in data.values())
            result_message = f"ì‘ì—… ì™„ë£Œ!\n\nìˆ˜ì§‘ëœ ë¶„ì–‘ì •ë³´: {total_count}ê±´\nìƒì„±ëœ íŒŒì¼: {os.path.basename(excel_file)}\nì „ì†¡ëœ ì´ë©”ì¼: {len(recipients)}ëª…"
            
            if success:
                self.root.after(0, lambda: messagebox.showinfo("ì‘ì—… ì™„ë£Œ", result_message))
                self.root.after(0, lambda: self.log_message("âœ… ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."))
            else:
                self.root.after(0, lambda: messagebox.showerror("ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨", f"ë¶„ì–‘ì •ë³´ ìˆ˜ì§‘ì€ ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n{message}"))
                self.root.after(0, lambda: self.log_message(f"âŒ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: {message}"))
                
        except Exception as e:
            error_msg = f"ì‹œìŠ¤í…œ ì‹¤í–‰ ì˜¤ë¥˜: {str(e)}"
            self.root.after(0, lambda: messagebox.showerror("ì‹¤í–‰ ì˜¤ë¥˜", error_msg))
            self.root.after(0, lambda: self.log_message(f"âŒ {error_msg}"))
            
        finally:
            self.root.after(0, self._reset_ui)
    
    def _reset_ui(self):
        """UI ìƒíƒœ ë¦¬ì…‹"""
        self.is_running = False
        self.run_btn.config(state='normal', text='ğŸš€ ì‹¤í–‰')
        self.progress_var.set(0)
        self.status_var.set("ì¤€ë¹„ ì™„ë£Œ")
    
    def update_progress(self, value: int, status: str):
        """ì§„í–‰ìƒíƒœ ì—…ë°ì´íŠ¸"""
        self.root.after(0, lambda: self.progress_var.set(value))
        self.root.after(0, lambda: self.status_var.set(status))
        self.root.after(0, lambda: self.log_message(status))
    
    def log_message(self, message: str):
        """ë¡œê·¸ ë©”ì‹œì§€ ì¶”ê°€"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        log_entry = f"[{timestamp}] {message}\n"
        
        def update_log():
            self.log_text.insert(tk.END, log_entry)
            self.log_text.see(tk.END)
        
        if threading.current_thread() == threading.main_thread():
            update_log()
        else:
            self.root.after(0, update_log)
        
        # íŒŒì¼ ë¡œê·¸ì—ë„ ê¸°ë¡
        self.logger.info(message)
    
    def clear_log(self):
        """ë¡œê·¸ ì§€ìš°ê¸°"""
        self.log_text.delete(1.0, tk.END)
        self.log_message("ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
    
    def on_closing(self):
        """ì°½ ë‹«ê¸° ì´ë²¤íŠ¸"""
        if self.is_running:
            if messagebox.askokcancel("ì¢…ë£Œ í™•ì¸", "ì‹œìŠ¤í…œì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì •ë§ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
                self.logger.info("ì‚¬ìš©ìì— ì˜í•´ í”„ë¡œê·¸ë¨ ì¢…ë£Œ")
                self.root.destroy()
        else:
            self.logger.info("í”„ë¡œê·¸ë¨ ì •ìƒ ì¢…ë£Œ")
            self.root.destroy()
    
    def run(self):
        """GUI ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰"""
        self.log_message("ì²­ì•½ ë¶„ì–‘ì •ë³´ ìë™í™” ì‹œìŠ¤í…œì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.")
        self.log_message("ì„¤ì •ì„ í™•ì¸í•˜ê³  'ì‹¤í–‰' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.")
        self.root.mainloop()

def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    try:
        app = SubscriptionGUI()
        app.run()
    except Exception as e:
        messagebox.showerror("ì‹œìŠ¤í…œ ì˜¤ë¥˜", f"í”„ë¡œê·¸ë¨ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n{str(e)}")

if __name__ == "__main__":
    main()