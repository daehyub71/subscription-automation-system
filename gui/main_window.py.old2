# GUI íŒŒì¼ ìƒë‹¨ import ë¶€ë¶„ ìˆ˜ì • ì˜ˆì œ
# gui/main_window.py íŒŒì¼ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•˜ì„¸ìš”:

import tkinter as tk
from tkinter import ttk, messagebox, filedialog, scrolledtext
import threading
import logging
import os
import sys
from datetime import datetime
from typing import Dict, List, Optional

# ìƒìœ„ ë””ë ‰í† ë¦¬ì˜ ëª¨ë“ˆ importë¥¼ ìœ„í•œ ê²½ë¡œ ì¶”ê°€
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# ìƒˆë¡œìš´ ConfigManager ì‚¬ìš©
from utils.config_manager import ConfigManager

class SubscriptionGUI:
    """ì²­ì•½ ë¶„ì–‘ì •ë³´ ìë™í™” ì‹œìŠ¤í…œ GUI í´ë˜ìŠ¤"""
    
    def __init__(self):
        """GUI ì´ˆê¸°í™”"""
        self.root = tk.Tk()
        self.setup_window()
        
        # ìƒˆë¡œìš´ ConfigManager ì´ˆê¸°í™”
        self.config_manager = ConfigManager()
        self.config_data = {}
        
        # ë¡œê¹… ì„¤ì •
        self.setup_logging()
        
        # GUI ì»´í¬ë„ŒíŠ¸ ì´ˆê¸°í™”
        self.create_widgets()
        
        # ì„¤ì • ì•ˆì „í•˜ê²Œ ë¡œë“œ (URL ì¸ì½”ë”© ë¬¸ì œ ìë™ í•´ê²°)
        self.safe_load_settings()
        
        # ì§„í–‰ìƒíƒœ ë³€ìˆ˜
        self.is_running = False
    
    def safe_load_settings(self):
        """ì„¤ì • ì•ˆì „í•˜ê²Œ ë¡œë“œ (URL ì¸ì½”ë”© ë¬¸ì œ ìë™ í•´ê²°)"""
        try:
            self.log_message("ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹œì‘...")
            
            # ìƒˆë¡œìš´ ConfigManagerë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì • ë¡œë“œ
            # URL ì¸ì½”ë”© ë¬¸ì œê°€ ìë™ìœ¼ë¡œ í•´ê²°ë©ë‹ˆë‹¤
            self.config_data = self.config_manager.load_config()
            
            # UIì— ì„¤ì • ë°˜ì˜
            self.load_config_to_ui()
            
            self.log_message("âœ… ì„¤ì • íŒŒì¼ ë¡œë“œ ì™„ë£Œ")
            
        except Exception as e:
            self.log_message(f"âŒ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: {e}")
            # ê¸°ë³¸ ì„¤ì • ì‚¬ìš©
            self.config_data = self.config_manager._get_default_config()
            messagebox.showerror("ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", 
                               f"ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.\n\nì˜¤ë¥˜: {e}")
    
    def load_config_to_ui(self):
        """ì„¤ì • ë°ì´í„°ë¥¼ UIì— ë¡œë“œ"""
        try:
            # API ì„¤ì •
            api_config = self.config_data.get('api', {})
            self.api_key_var.set(api_config.get('service_key', ''))
            
            # ì´ë©”ì¼ ì„¤ì •
            email_config = self.config_data.get('email', {})
            self.sender_email_var.set(email_config.get('sender_email', ''))
            self.app_password_var.set(email_config.get('app_password', ''))
            
            # ìˆ˜ì‹ ì ëª©ë¡ ë¡œë“œ
            self.recipients_listbox.delete(0, tk.END)
            recipients = email_config.get('recipients', [])
            for recipient in recipients:
                if recipient and recipient.strip():
                    self.recipients_listbox.insert(tk.END, recipient.strip())
            
            # ì¹´ì¹´ì˜¤í†¡ ì„¤ì •
            kakao_config = self.config_data.get('kakao', {})
            self.kakao_enabled_var.set(kakao_config.get('enabled', False))
            self.kakao_api_key_var.set(kakao_config.get('api_key', ''))
            self.toggle_kakao_settings()
            
            # ìŠ¤ì¼€ì¤„ ì„¤ì •
            schedule_config = self.config_data.get('schedule', {})
            self.schedule_enabled_var.set(schedule_config.get('enabled', False))
            self.schedule_time_var.set(schedule_config.get('time', '09:00'))
            self.toggle_schedule_settings()
            
            self.log_message("âœ… ì„¤ì • UI ë¡œë“œ ì™„ë£Œ")
            
        except Exception as e:
            self.log_message(f"âŒ UI ë¡œë“œ ì˜¤ë¥˜: {e}")
    
    def save_settings(self):
        """ì„¤ì • ì €ì¥"""
        try:
            # ìˆ˜ì‹ ì ëª©ë¡ ìˆ˜ì§‘
            recipients = [self.recipients_listbox.get(i) for i in range(self.recipients_listbox.size())]
            
            # ì„¤ì • ë°ì´í„° êµ¬ì„±
            config_data = {
                'api': {
                    'service_key': self.api_key_var.get().strip(),
                    'max_rows': 50,
                    'timeout': 30
                },
                'email': {
                    'sender_email': self.sender_email_var.get().strip(),
                    'app_password': self.app_password_var.get().strip(),
                    'recipients': recipients,
                    'smtp_server': 'smtp.gmail.com',
                    'smtp_port': 587
                },
                'kakao': {
                    'enabled': self.kakao_enabled_var.get(),
                    'api_key': self.kakao_api_key_var.get().strip(),
                    'template_id': ''
                },
                'schedule': {
                    'enabled': self.schedule_enabled_var.get(),
                    'time': self.schedule_time_var.get().strip(),
                    'frequency': 'daily'
                },
                'files': {
                    'output_dir': 'output',
                    'filename_format': 'ì²­ì•½ë¶„ì–‘ì •ë³´_{timestamp}.xlsx'
                },
                'logging': {
                    'level': 'INFO',
                    'file_enabled': True,
                    'console_enabled': True
                }
            }
            
            # ìƒˆë¡œìš´ ConfigManagerë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ì • ì €ì¥
            # ìë™ìœ¼ë¡œ ë°±ì—… ìƒì„±, ìœ íš¨ì„± ê²€ì¦, ì•”í˜¸í™”ê°€ ìˆ˜í–‰ë©ë‹ˆë‹¤
            if self.config_manager.save_config(config_data):
                messagebox.showinfo("ì„¤ì • ì €ì¥", "ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
                self.log_message("âœ… ì„¤ì • ì €ì¥ ì™„ë£Œ")
                self.config_data = config_data
            else:
                messagebox.showerror("ì„¤ì • ì €ì¥ ì‹¤íŒ¨", "ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                
        except Exception as e:
            error_msg = f"ì„¤ì • ì €ì¥ ì˜¤ë¥˜: {str(e)}"
            messagebox.showerror("ì˜¤ë¥˜", error_msg)
            self.log_message(f"âŒ {error_msg}")
    
    def create_button_section(self, parent, start_row):
        """ë²„íŠ¼ ì„¹ì…˜ ìƒì„± (ì¶”ê°€ ê¸°ëŠ¥ í¬í•¨)"""
        # ë²„íŠ¼ í”„ë ˆì„
        button_frame = ttk.Frame(parent)
        button_frame.grid(row=start_row, column=0, columnspan=3, pady=20)
        
        # ì‹¤í–‰ ë²„íŠ¼
        self.run_btn = ttk.Button(button_frame, text="ğŸš€ ì‹¤í–‰", command=self.run_system, 
                                 style='Accent.TButton', width=12)
        self.run_btn.grid(row=0, column=0, padx=5)
        
        # ì„¤ì • ì €ì¥ ë²„íŠ¼
        ttk.Button(button_frame, text="ğŸ’¾ ì„¤ì •ì €ì¥", command=self.save_settings, width=12).grid(row=0, column=1, padx=5)
        
        # ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼
        ttk.Button(button_frame, text="ğŸ“ ì„¤ì •ë¶ˆëŸ¬ì˜¤ê¸°", command=self.safe_load_settings, width=12).grid(row=0, column=2, padx=5)
        
        # ì—‘ì…€ í…ŒìŠ¤íŠ¸ ë²„íŠ¼
        ttk.Button(button_frame, text="ğŸ“Š ì—‘ì…€í…ŒìŠ¤íŠ¸", command=self.test_excel_creation, width=12).grid(row=0, column=3, padx=5)
        
        # ì¶”ê°€ ê¸°ëŠ¥ ë²„íŠ¼ë“¤ (ë‘ ë²ˆì§¸ ì¤„)
        ttk.Button(button_frame, text="ğŸ”§ ì„¤ì •ìˆ˜ì •", command=self.fix_config_file, width=12).grid(row=1, column=0, padx=5, pady=5)
        ttk.Button(button_frame, text="ğŸ”„ ì´ˆê¸°í™”", command=self.reset_config, width=12).grid(row=1, column=1, padx=5, pady=5)
        ttk.Button(button_frame, text="ğŸ“¤ ë‚´ë³´ë‚´ê¸°", command=self.export_config, width=12).grid(row=1, column=2, padx=5, pady=5)
        ttk.Button(button_frame, text="ğŸ“¥ ê°€ì ¸ì˜¤ê¸°", command=self.import_config, width=12).grid(row=1, column=3, padx=5, pady=5)
        
        # ì¢…ë£Œ ë²„íŠ¼
        ttk.Button(button_frame, text="âŒ ì¢…ë£Œ", command=self.on_closing, width=12).grid(row=1, column=4, padx=5, pady=5)
    
    def fix_config_file(self):
        """ì„¤ì • íŒŒì¼ URL ì¸ì½”ë”© ë¬¸ì œ ìˆ˜ì •"""
        try:
            if self.config_manager.fix_url_encoding_issues():
                messagebox.showinfo("ìˆ˜ì • ì™„ë£Œ", "ì„¤ì • íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!")
                self.log_message("âœ… ì„¤ì • íŒŒì¼ ìˆ˜ì • ì™„ë£Œ")
                # ì„¤ì • ë‹¤ì‹œ ë¡œë“œ
                self.safe_load_settings()
            else:
                messagebox.showerror("ìˆ˜ì • ì‹¤íŒ¨", "ì„¤ì • íŒŒì¼ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                
        except Exception as e:
            error_msg = f"ì„¤ì • íŒŒì¼ ìˆ˜ì • ì˜¤ë¥˜: {e}"
            messagebox.showerror("ìˆ˜ì • ì‹¤íŒ¨", error_msg)
            self.log_message(f"âŒ {error_msg}")
    
    def reset_config(self):
        """ì„¤ì • ì´ˆê¸°í™”"""
        if messagebox.askyesno("ì„¤ì • ì´ˆê¸°í™”", "ëª¨ë“  ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë°±ì—…ì´ ìƒì„±ë©ë‹ˆë‹¤)"):
            try:
                if self.config_manager.reset_config():
                    messagebox.showinfo("ì´ˆê¸°í™” ì™„ë£Œ", "ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
                    self.log_message("âœ… ì„¤ì • ì´ˆê¸°í™” ì™„ë£Œ")
                    # ì„¤ì • ë‹¤ì‹œ ë¡œë“œ
                    self.safe_load_settings()
                else:
                    messagebox.showerror("ì´ˆê¸°í™” ì‹¤íŒ¨", "ì„¤ì • ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                    
            except Exception as e:
                error_msg = f"ì„¤ì • ì´ˆê¸°í™” ì˜¤ë¥˜: {e}"
                messagebox.showerror("ì´ˆê¸°í™” ì‹¤íŒ¨", error_msg)
                self.log_message(f"âŒ {error_msg}")
    
    def export_config(self):
        """ì„¤ì • ë‚´ë³´ë‚´ê¸°"""
        try:
            file_path = filedialog.asksaveasfilename(
                title="ì„¤ì • íŒŒì¼ ë‚´ë³´ë‚´ê¸°",
                defaultextension=".json",
                filetypes=[("JSON files", "*.json"), ("All files", "*.*")]
            )
            
            if file_path:
                include_sensitive = messagebox.askyesno("ë¯¼ê°ì •ë³´ í¬í•¨", 
                                                       "ë¯¼ê°ì •ë³´(ë¹„ë°€ë²ˆí˜¸, API í‚¤)ë„ í•¨ê»˜ ë‚´ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?")
                
                if self.config_manager.export_config(file_path, include_sensitive):
                    messagebox.showinfo("ë‚´ë³´ë‚´ê¸° ì™„ë£Œ", f"ì„¤ì •ì´ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤:\n{file_path}")
                    self.log_message(f"âœ… ì„¤ì • ë‚´ë³´ë‚´ê¸° ì™„ë£Œ: {file_path}")
                else:
                    messagebox.showerror("ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨", "ì„¤ì • ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                    
        except Exception as e:
            error_msg = f"ì„¤ì • ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜: {e}"
            messagebox.showerror("ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨", error_msg)
            self.log_message(f"âŒ {error_msg}")
    
    def import_config(self):
        """ì„¤ì • ê°€ì ¸ì˜¤ê¸°"""
        try:
            file_path = filedialog.askopenfilename(
                title="ì„¤ì • íŒŒì¼ ê°€ì ¸ì˜¤ê¸°",
                filetypes=[("JSON files", "*.json"), ("All files", "*.*")]
            )
            
            if file_path:
                if messagebox.askyesno("ì„¤ì • ê°€ì ¸ì˜¤ê¸°", 
                                     f"í˜„ì¬ ì„¤ì •ì„ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë°±ì—…ì´ ìƒì„±ë©ë‹ˆë‹¤)\n\níŒŒì¼: {file_path}"):
                    
                    if self.config_manager.import_config(file_path):
                        messagebox.showinfo("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ", "ì„¤ì •ì´ ê°€ì ¸ì™€ì¡ŒìŠµë‹ˆë‹¤.")
                        self.log_message(f"âœ… ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: {file_path}")
                        # ì„¤ì • ë‹¤ì‹œ ë¡œë“œ
                        self.safe_load_settings()
                    else:
                        messagebox.showerror("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", "ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                        
        except Exception as e:
            error_msg = f"ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜: {e}"
            messagebox.showerror("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", error_msg)
            self.log_message(f"âŒ {error_msg}")

# ì‚¬ìš© ì˜ˆì œ
if __name__ == "__main__":
    # ConfigManager ë‹¨ë… í…ŒìŠ¤íŠ¸
    config_manager = ConfigManager()
    
    # ì„¤ì • ì •ë³´ í™•ì¸
    info = config_manager.get_config_info()
    print(f"ì„¤ì • íŒŒì¼: {info['config_file']}")
    print(f"ì•”í˜¸í™” ì‚¬ìš©: {info['encryption_enabled']}")
    
    # ì„¤ì • ë¡œë“œ (URL ì¸ì½”ë”© ë¬¸ì œ ìë™ í•´ê²°)
    config = config_manager.load_config()
    print(f"ë¡œë“œëœ ì„¤ì •: {list(config.keys())}")
    
    # URL ì¸ì½”ë”© ë¬¸ì œ ìˆ˜ì •
    config_manager.fix_url_encoding_issues()