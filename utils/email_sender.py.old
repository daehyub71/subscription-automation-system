#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ì´ë©”ì¼ ì „ì†¡ ëª¨ë“ˆ
íŒŒì¼ëª…: utils/email_sender.py
ì‘ì„±ì: ì²­ì•½ ìë™í™” ì‹œìŠ¤í…œ
ì„¤ëª…: Gmail SMTPë¥¼ í†µí•œ ì´ë©”ì¼ ì „ì†¡ ë° íŒŒì¼ ì²¨ë¶€
"""

import smtplib
import os
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase
from email import encoders
from datetime import datetime
import logging
from typing import List, Optional, Dict, Tuple

class EmailSender:
    """Gmail SMTP ì´ë©”ì¼ ì „ì†¡ í´ë˜ìŠ¤"""
    
    def __init__(self, smtp_server: str = "smtp.gmail.com", smtp_port: int = 587):
        """
        ì´ˆê¸°í™”
        Args:
            smtp_server (str): SMTP ì„œë²„ ì£¼ì†Œ
            smtp_port (int): SMTP í¬íŠ¸ ë²ˆí˜¸
        """
        self.smtp_server = smtp_server
        self.smtp_port = smtp_port
        self.logger = logging.getLogger(__name__)
    
    def test_connection(self, sender_email: str, app_password: str) -> Tuple[bool, str]:
        """
        SMTP ì—°ê²° í…ŒìŠ¤íŠ¸
        Args:
            sender_email (str): ë°œì‹ ì ì´ë©”ì¼
            app_password (str): Gmail ì•± ë¹„ë°€ë²ˆí˜¸
        Returns:
            Tuple[bool, str]: (ì„±ê³µì—¬ë¶€, ë©”ì‹œì§€)
        """
        try:
            self.logger.info("SMTP ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘")
            
            # SMTP ì„œë²„ ì—°ê²°
            server = smtplib.SMTP(self.smtp_server, self.smtp_port)
            server.starttls()  # TLS ë³´ì•ˆ ì—°ê²°
            
            # ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
            server.login(sender_email, app_password)
            server.quit()
            
            self.logger.info("SMTP ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ")
            return True, "SMTP ì—°ê²° ì„±ê³µ"
            
        except smtplib.SMTPAuthenticationError as e:
            error_msg = f"ì¸ì¦ ì‹¤íŒ¨: Gmail ì£¼ì†Œ ë˜ëŠ” ì•± ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”. ({e})"
            self.logger.error(error_msg)
            return False, error_msg
            
        except smtplib.SMTPConnectError as e:
            error_msg = f"SMTP ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”. ({e})"
            self.logger.error(error_msg)
            return False, error_msg
            
        except Exception as e:
            error_msg = f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {str(e)}"
            self.logger.error(error_msg)
            return False, error_msg
    
    def send_subscription_email(self, 
                               sender_email: str, 
                               app_password: str,
                               recipients: List[str], 
                               excel_file_path: str,
                               data_summary: Dict) -> Tuple[bool, str]:
        """
        ì²­ì•½ ë¶„ì–‘ì •ë³´ ì´ë©”ì¼ ì „ì†¡
        Args:
            sender_email (str): ë°œì‹ ì ì´ë©”ì¼
            app_password (str): Gmail ì•± ë¹„ë°€ë²ˆí˜¸  
            recipients (List[str]): ìˆ˜ì‹ ì ì´ë©”ì¼ ëª©ë¡
            excel_file_path (str): ì²¨ë¶€í•  ì—‘ì…€ íŒŒì¼ ê²½ë¡œ
            data_summary (Dict): ë°ì´í„° ìš”ì•½ ì •ë³´
        Returns:
            Tuple[bool, str]: (ì„±ê³µì—¬ë¶€, ë©”ì‹œì§€)
        """
        try:
            self.logger.info(f"ì´ë©”ì¼ ì „ì†¡ ì‹œì‘: {len(recipients)}ëª…ì˜ ìˆ˜ì‹ ì")
            
            # ì´ë©”ì¼ ë©”ì‹œì§€ ìƒì„±
            msg = self._create_email_message(
                sender_email, 
                recipients, 
                excel_file_path, 
                data_summary
            )
            
            # SMTP ì„œë²„ ì—°ê²° ë° ì „ì†¡
            server = smtplib.SMTP(self.smtp_server, self.smtp_port)
            server.starttls()
            server.login(sender_email, app_password)
            
            # ì´ë©”ì¼ ì „ì†¡
            text = msg.as_string()
            server.sendmail(sender_email, recipients, text)
            server.quit()
            
            success_msg = f"ì´ë©”ì¼ ì „ì†¡ ì„±ê³µ: {len(recipients)}ëª…"
            self.logger.info(success_msg)
            return True, success_msg
            
        except Exception as e:
            error_msg = f"ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: {str(e)}"
            self.logger.error(error_msg)
            return False, error_msg
    
    def _create_email_message(self, 
                             sender_email: str, 
                             recipients: List[str], 
                             excel_file_path: str,
                             data_summary: Dict) -> MIMEMultipart:
        """
        ì´ë©”ì¼ ë©”ì‹œì§€ ìƒì„±
        Args:
            sender_email (str): ë°œì‹ ì ì´ë©”ì¼
            recipients (List[str]): ìˆ˜ì‹ ì ëª©ë¡
            excel_file_path (str): ì—‘ì…€ íŒŒì¼ ê²½ë¡œ
            data_summary (Dict): ë°ì´í„° ìš”ì•½ ì •ë³´
        Returns:
            MIMEMultipart: ì´ë©”ì¼ ë©”ì‹œì§€ ê°ì²´
        """
        # ë©”ì‹œì§€ ê°ì²´ ìƒì„±
        msg = MIMEMultipart('alternative')
        
        # ì´ë©”ì¼ í—¤ë” ì„¤ì •
        msg['From'] = sender_email
        msg['To'] = ', '.join(recipients)
        msg['Subject'] = f"ğŸ  ì²­ì•½ ë¶„ì–‘ì •ë³´ ì—…ë°ì´íŠ¸ - {datetime.now().strftime('%Yë…„ %mì›” %dì¼')}"
        
        # ì´ë©”ì¼ ë³¸ë¬¸ ìƒì„±
        html_body = self._create_html_body(data_summary, excel_file_path)
        text_body = self._create_text_body(data_summary)
        
        # ë³¸ë¬¸ ì²¨ë¶€
        part1 = MIMEText(text_body, 'plain', 'utf-8')
        part2 = MIMEText(html_body, 'html', 'utf-8')
        
        msg.attach(part1)
        msg.attach(part2)
        
        # ì—‘ì…€ íŒŒì¼ ì²¨ë¶€
        if excel_file_path and os.path.exists(excel_file_path):
            self._attach_file(msg, excel_file_path)
            self.logger.info(f"ì²¨ë¶€íŒŒì¼ ì¶”ê°€: {os.path.basename(excel_file_path)}")
        
        return msg
    
    def _create_html_body(self, data_summary: Dict, excel_file_path: str) -> str:
        """
        HTML ì´ë©”ì¼ ë³¸ë¬¸ ìƒì„±
        Args:
            data_summary (Dict): ë°ì´í„° ìš”ì•½ ì •ë³´
            excel_file_path (str): ì—‘ì…€ íŒŒì¼ ê²½ë¡œ
        Returns:
            str: HTML ë³¸ë¬¸
        """
        # í†µê³„ ê³„ì‚°
        total_count = sum(len(data_list) for data_list in data_summary.values() if isinstance(data_list, list))
        general_count = len(data_summary.get('general', []))
        apt_count = len(data_summary.get('apt', []))
        officetel_count = len(data_summary.get('officetel', []))
        
        # íŒŒì¼ëª… ì¶”ì¶œ
        filename = os.path.basename(excel_file_path) if excel_file_path else "ë¶„ì–‘ì •ë³´.xlsx"
        
        # ìµœì‹  ë¶„ì–‘ì •ë³´ (ìƒìœ„ 5ê°œ)
        recent_items = []
        all_items = []
        
        for category, items in data_summary.items():
            if isinstance(items, list):
                for item in items:
                    item_with_category = item.copy()
                    item_with_category['ë¶„ì–‘ìœ í˜•'] = {
                        'general': 'ì¼ë°˜ë¶„ì–‘',
                        'apt': 'APTë¶„ì–‘',
                        'officetel': 'ì˜¤í”¼ìŠ¤í…”ë¶„ì–‘'
                    }.get(category, category)
                    all_items.append(item_with_category)
        
        # ìµœì‹ ìˆœ ì •ë ¬
        try:
            all_items.sort(key=lambda x: x.get('ëª¨ì§‘ê³µê³ ì¼', ''), reverse=True)
            recent_items = all_items[:5]
        except:
            recent_items = all_items[:5]
        
        # ìµœì‹  ë¶„ì–‘ì •ë³´ HTML ìƒì„±
        recent_items_html = ""
        for i, item in enumerate(recent_items, 1):
            recent_items_html += f"""
            <tr style="background-color: {'#f9f9f9' if i % 2 == 0 else '#ffffff'};">
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">{i}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">{item.get('ë¶„ì–‘ìœ í˜•', '')}</td>
                <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">{item.get('ì£¼íƒëª…', '')}</td>
                <td style="padding: 8px; border: 1px solid #ddd;">{item.get('ê³µê¸‰ì§€ì—­', '')}</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">{item.get('ëª¨ì§‘ê³µê³ ì¼', '')}</td>
            </tr>
            """
        
        html_body = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                body {{ 
                    font-family: 'ë§‘ì€ ê³ ë”•', Arial, sans-serif; 
                    line-height: 1.6;
                    color: #333;
                    margin: 0;
                    padding: 20px;
                }}
                .container {{
                    max-width: 800px;
                    margin: 0 auto;
                    background-color: #ffffff;
                    border-radius: 10px;
                    overflow: hidden;
                    box-shadow: 0 0 20px rgba(0,0,0,0.1);
                }}
                .header {{ 
                    background: linear-gradient(135deg, #4F81BD 0%, #6BA3E0 100%);
                    color: white; 
                    padding: 30px;
                    text-align: center;
                }}
                .header h1 {{
                    margin: 0;
                    font-size: 24px;
                    font-weight: bold;
                }}
                .content {{ 
                    padding: 30px;
                }}
                .summary {{ 
                    background-color: #f8f9fa; 
                    padding: 20px; 
                    margin: 20px 0;
                    border-radius: 8px;
                    border-left: 4px solid #4F81BD;
                }}
                .summary h3 {{
                    margin-top: 0;
                    color: #4F81BD;
                    font-size: 18px;
                }}
                .stats {{
                    display: flex;
                    justify-content: space-around;
                    margin: 20px 0;
                    flex-wrap: wrap;
                }}
                .stat-item {{
                    text-align: center;
                    padding: 15px;
                    background-color: white;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    margin: 5px;
                    min-width: 120px;
                }}
                .stat-number {{
                    font-size: 24px;
                    font-weight: bold;
                    color: #4F81BD;
                }}
                .stat-label {{
                    font-size: 12px;
                    color: #666;
                    margin-top: 5px;
                }}
                .recent-table {{
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                    background-color: white;
                    border-radius: 8px;
                    overflow: hidden;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }}
                .recent-table th {{
                    background-color: #4F81BD;
                    color: white;
                    padding: 12px 8px;
                    text-align: center;
                    font-weight: bold;
                }}
                .recent-table td {{
                    padding: 8px;
                    border: 1px solid #ddd;
                }}
                .footer {{
                    background-color: #f8f9fa;
                    padding: 20px;
                    text-align: center;
                    color: #666;
                    border-top: 1px solid #eee;
                }}
                .attachment {{
                    background-color: #e8f4f8;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 20px 0;
                    border: 1px solid #4F81BD;
                }}
                .attachment-icon {{
                    color: #4F81BD;
                    font-size: 18px;
                    margin-right: 10px;
                }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>ğŸ  ì²­ì•½ ë¶„ì–‘ì •ë³´ ì—…ë°ì´íŠ¸</h1>
                    <p style="margin: 10px 0 0 0; opacity: 0.9;">
                        {datetime.now().strftime('%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„')} ê¸°ì¤€
                    </p>
                </div>
                
                <div class="content">
                    <p>ì•ˆë…•í•˜ì„¸ìš”! ìµœì‹  ì²­ì•½ ë¶„ì–‘ì •ë³´ë¥¼ ì „ë‹¬ë“œë¦½ë‹ˆë‹¤.</p>
                    
                    <div class="summary">
                        <h3>ğŸ“Š ë¶„ì–‘ì •ë³´ ìš”ì•½</h3>
                        <div class="stats">
                            <div class="stat-item">
                                <div class="stat-number">{total_count}</div>
                                <div class="stat-label">ì´ ë¶„ì–‘ê±´ìˆ˜</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">{general_count}</div>
                                <div class="stat-label">ì¼ë°˜ë¶„ì–‘</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">{apt_count}</div>
                                <div class="stat-label">APTë¶„ì–‘</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">{officetel_count}</div>
                                <div class="stat-label">ì˜¤í”¼ìŠ¤í…”ë¶„ì–‘</div>
                            </div>
                        </div>
                    </div>
                    
                    {f'''
                    <h3 style="color: #4F81BD; margin-top: 30px;">ğŸ  ìµœì‹  ë¶„ì–‘ì •ë³´ (ìƒìœ„ 5ê°œ)</h3>
                    <table class="recent-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">ìˆœë²ˆ</th>
                                <th style="width: 100px;">ë¶„ì–‘ìœ í˜•</th>
                                <th style="width: 200px;">ì£¼íƒëª…</th>
                                <th style="width: 150px;">ê³µê¸‰ì§€ì—­</th>
                                <th style="width: 100px;">ëª¨ì§‘ê³µê³ ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {recent_items_html}
                        </tbody>
                    </table>
                    ''' if recent_items else '<p style="color: #666; text-align: center; padding: 20px;">í‘œì‹œí•  ë¶„ì–‘ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
                    
                    <div class="attachment">
                        <span class="attachment-icon">ğŸ“</span>
                        <strong>ì²¨ë¶€íŒŒì¼:</strong> {filename}
                        <br>
                        <small style="color: #666;">ìì„¸í•œ ë¶„ì–‘ì •ë³´ëŠ” ì²¨ë¶€ëœ ì—‘ì…€ íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</small>
                    </div>
                    
                    <p style="margin-top: 30px;">
                        ê¶ê¸ˆí•œ ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ì—°ë½ì£¼ì„¸ìš”.<br>
                        ê°ì‚¬í•©ë‹ˆë‹¤.
                    </p>
                </div>
                
                <div class="footer">
                    <p>
                        <strong>ì²­ì•½ ë¶„ì–‘ì •ë³´ ìë™í™” ì‹œìŠ¤í…œ</strong><br>
                        ì´ ì´ë©”ì¼ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </body>
        </html>
        """
        
        return html_body
    
    def _create_text_body(self, data_summary: Dict) -> str:
        """
        í…ìŠ¤íŠ¸ ì´ë©”ì¼ ë³¸ë¬¸ ìƒì„± (HTMLì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë©”ì¼ í´ë¼ì´ì–¸íŠ¸ìš©)
        Args:
            data_summary (Dict): ë°ì´í„° ìš”ì•½ ì •ë³´
        Returns:
            str: í…ìŠ¤íŠ¸ ë³¸ë¬¸
        """
        total_count = sum(len(data_list) for data_list in data_summary.values() if isinstance(data_list, list))
        general_count = len(data_summary.get('general', []))
        apt_count = len(data_summary.get('apt', []))
        officetel_count = len(data_summary.get('officetel', []))
        
        text_body = f"""
ì²­ì•½ ë¶„ì–‘ì •ë³´ ì—…ë°ì´íŠ¸
{datetime.now().strftime('%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„')} ê¸°ì¤€

ì•ˆë…•í•˜ì„¸ìš”! ìµœì‹  ì²­ì•½ ë¶„ì–‘ì •ë³´ë¥¼ ì „ë‹¬ë“œë¦½ë‹ˆë‹¤.

ğŸ“Š ë¶„ì–‘ì •ë³´ ìš”ì•½
- ì´ ë¶„ì–‘ê±´ìˆ˜: {total_count}ê±´
- ì¼ë°˜ë¶„ì–‘: {general_count}ê±´  
- APTë¶„ì–‘: {apt_count}ê±´
- ì˜¤í”¼ìŠ¤í…”ë¶„ì–‘: {officetel_count}ê±´

ìì„¸í•œ ì •ë³´ëŠ” ì²¨ë¶€ëœ ì—‘ì…€ íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.

ê°ì‚¬í•©ë‹ˆë‹¤.

---
ì²­ì•½ ë¶„ì–‘ì •ë³´ ìë™í™” ì‹œìŠ¤í…œ
ì´ ì´ë©”ì¼ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
        """
        
        return text_body.strip()
    
    def _attach_file(self, msg: MIMEMultipart, file_path: str):
        """
        íŒŒì¼ ì²¨ë¶€ (í•œê¸€ íŒŒì¼ëª… ì™„ë²½ ì§€ì›)
        """
        try:
            if not os.path.exists(file_path):
                self.logger.warning(f"ì²¨ë¶€íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: {file_path}")
                return
            
            # íŒŒì¼ëª… ì¶”ì¶œ
            filename = os.path.basename(file_path)
            
            # íŒŒì¼ ì½ê¸°
            with open(file_path, "rb") as attachment:
                # XLSX íŒŒì¼ìš© MIME íƒ€ì…
                part = MIMEBase('application', 'vnd.openxmlformats-officedocument.spreadsheetml.sheet')
                part.set_payload(attachment.read())
            
            # Base64 ì¸ì½”ë”©
            encoders.encode_base64(part)
            
            # í•œê¸€ íŒŒì¼ëª… ì²˜ë¦¬
            import urllib.parse
            
            # URL ì¸ì½”ë”©ìœ¼ë¡œ í•œê¸€ íŒŒì¼ëª… ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            encoded_filename = urllib.parse.quote(filename)
            
            # Content-Disposition í—¤ë” ì„¤ì • (RFC 2231 ë°©ì‹)
            part.add_header(
                'Content-Disposition',
                f'attachment; filename*=UTF-8\'\'{encoded_filename}; filename="{filename}"'
            )
            
            # ì¶”ê°€ í—¤ë” ì„¤ì •
            part.add_header('Content-Type', f'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet; name="{filename}"')
            
            # ë©”ì‹œì§€ì— ì²¨ë¶€
            msg.attach(part)
            
            self.logger.info(f"ì²¨ë¶€íŒŒì¼ ì¶”ê°€ ì™„ë£Œ: {filename}")
            
        except Exception as e:
            self.logger.error(f"íŒŒì¼ ì²¨ë¶€ ì˜¤ë¥˜: {e}")
    
    def send_test_email(self, sender_email: str, app_password: str, test_recipient: str) -> Tuple[bool, str]:
        """
        í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ ì „ì†¡
        Args:
            sender_email (str): ë°œì‹ ì ì´ë©”ì¼
            app_password (str): Gmail ì•± ë¹„ë°€ë²ˆí˜¸
            test_recipient (str): í…ŒìŠ¤íŠ¸ ìˆ˜ì‹ ì
        Returns:
            Tuple[bool, str]: (ì„±ê³µì—¬ë¶€, ë©”ì‹œì§€)
        """
        try:
            msg = MIMEMultipart()
            msg['From'] = sender_email
            msg['To'] = test_recipient
            msg['Subject'] = "ğŸ§ª ì²­ì•½ ì‹œìŠ¤í…œ ì´ë©”ì¼ í…ŒìŠ¤íŠ¸"
            
            body = f"""
ì´ë©”ì¼ ì„¤ì • í…ŒìŠ¤íŠ¸

ë°œì‹ ì: {sender_email}
ìˆ˜ì‹ ì: {test_recipient}
í…ŒìŠ¤íŠ¸ ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

ì´ ì´ë©”ì¼ì„ ë°›ìœ¼ì…¨ë‹¤ë©´ ì´ë©”ì¼ ì„¤ì •ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œëœ ê²ƒì…ë‹ˆë‹¤! ğŸ‰

ì²­ì•½ ë¶„ì–‘ì •ë³´ ìë™í™” ì‹œìŠ¤í…œ
            """
            
            msg.attach(MIMEText(body, 'plain', 'utf-8'))
            
            # SMTP ì „ì†¡
            server = smtplib.SMTP(self.smtp_server, self.smtp_port)
            server.starttls()
            server.login(sender_email, app_password)
            server.sendmail(sender_email, test_recipient, msg.as_string())
            server.quit()
            
            success_msg = f"í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ ì „ì†¡ ì„±ê³µ: {test_recipient}"
            self.logger.info(success_msg)
            return True, success_msg
            
        except Exception as e:
            error_msg = f"í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨: {str(e)}"
            self.logger.error(error_msg)
            return False, error_msg